<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="plan">
  <insert id="insertPlan" useGeneratedKeys="true" keyProperty="idx">
    INSERT INTO plan_table (user_idx, area_code, title, start_date, end_date, status)
    VALUES (#{user_idx}, #{area_code}, #{title}, #{start_date}, #{end_date}, #{status});
  </insert>

  <insert id="insertDate" parameterType="map" useGeneratedKeys="true" keyProperty="idx">
    INSERT INTO date_table (plan_idx, date, memo) VALUES (#{plan_idx}, #{date}, '');
  </insert>

  <!--  VO pk가 비어있다.
   insert 되는 수간 비어있던 pk에 값이 들어간다.
  -->


  <insert id="insertPlace" parameterType="mybatis.vo.PlaceVO">
    INSERT INTO place_table (date_idx, visit_order, content_id, content_type_id, title, thumbnail, map_x, map_y, time)
    VALUES (#{date_idx}, #{visit_order}, #{content_id}, #{content_type_id}, #{title}, #{thumbnail}, #{map_x}, #{map_y}, #{time});
  </insert>

  <!-- Get the plan from plan_table -->
  <select id="getPlanById" parameterType="String" resultType="mybatis.vo.PlanVO">
    SELECT idx, user_idx, area_code, title, start_date, end_date, status
    FROM plan_table
    WHERE idx = #{planId}
  </select>

  <!-- Get all dates for a plan -->
  <select id="getDatesByPlanId" parameterType="String" resultType="mybatis.vo.DateVO">
    SELECT idx, plan_idx, date, memo
    FROM date_table
    WHERE plan_idx = #{planId}
    ORDER BY date
  </select>

  <!-- Get all places for a given date -->
  <select id="getPlacesByDateId" parameterType="String" resultType="mybatis.vo.PlaceVO">
    SELECT idx as place_idx, date_idx, visit_order, content_id, content_type_id, title, thumbnail, map_x, map_y, time
    FROM place_table
    WHERE date_idx = #{dateId}
    ORDER BY visit_order
  </select>

  <select id="get_favorite_place" parameterType="String" resultType="mybatis.vo.planning.TouristSpotVO">
    SELECT * FROM place_like_table
    WHERE user_idx = #{user_idx} ORDER BY idx DESC
  </select>
</mapper>